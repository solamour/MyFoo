name: release

on:
  workflow_call:
    inputs:
      repoName:
        required: true
        type: string
      tagName:
        required: true
        type: string
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      # https://github.com/actions/download-artifact
      - name: download artifact
        uses: actions/download-artifact@v5
        with:
          path: ./

      - name: set repoName and tagName
        run: |
          echo "REPO_NAME=${{ inputs.repoName }}" >> $GITHUB_ENV
          echo "TAG_NAME=${{ inputs.tagName }}" >> $GITHUB_ENV

      - name: zip
        run: |          
          DEBUG_DIR=${{ env.REPO_NAME }}_debug_${{ env.TAG_NAME }}
          (cd "./$DEBUG_DIR" && \
            zip -r ../${{ env.REPO_NAME }}_debug_${{ env.TAG_NAME }}.zip .)

          RELEASE_DIR=${{ env.REPO_NAME }}_release_${{ env.TAG_NAME }}
          (cd "./$RELEASE_DIR" && \
            zip -r ../${{ env.REPO_NAME }}_release_${{ env.TAG_NAME }}.zip .)

          ls -laR ./

      # https://github.com/actions/github-script
      - name: create tag
        uses: actions/github-script@v8
        with:
          github-token: ${{ github.token }}
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: "refs/tags/${{ env.TAG_NAME }}",
              sha: context.sha
            })

      # https://github.com/marketplace/actions/create-release
      - name: release action
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.TAG_NAME }}
          artifacts: >
            ./${{ env.REPO_NAME }}_*_${{ env.TAG_NAME }}.zip
